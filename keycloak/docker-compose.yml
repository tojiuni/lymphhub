version: '3.8'
services:
  keycloak:
    image: quay.io/keycloak/keycloak:26.2.5
    container_name: keycloak
    env_file:
      - .env
    environment:
      # 관리자 계정 설정
      KC_BOOTSTRAP_ADMIN_USERNAME: ${KEYCLOAK_ADMIN_ID}
      KC_BOOTSTRAP_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD}
      # 데이터베이스 설정 (기존 PostgreSQL 사용)
      KC_DB: postgres
      KC_DB_URL_HOST: neunexus_postgres_db
      KC_DB_URL_PORT: 5432
      KC_DB_URL_DATABASE: ${KEYCLOAK_DB_NAME}
      KC_DB_USERNAME: ${POSTGRES_USER}
      KC_DB_PASSWORD: ${POSTGRES_PASSWORD}
      KC_DB_SCHEMA: public
      # HTTPS 프록시 설정 (중요!)
      KC_HOSTNAME: auth.lyckabc.xyz
      KC_HOSTNAME_STRICT: true
      KC_HOSTNAME_STRICT_HTTPS: false
      KC_HTTP_ENABLED: true
      KC_PROXY: edge
      KC_PROXY_HEADERS: xforwarded
      PROXY_ADDRESS_FORWARDING: true
      # Frontend URL을 HTTPS로 명시적 설정
      KC_FRONTEND_URL: https://auth.lyckabc.xyz
      # Health check 설정
      KC_HEALTH_ENABLED: true
      KC_METRICS_ENABLED: true
      # 로그 레벨
      KC_LOG_LEVEL: INFO
      # Cache 설정
      KC_CACHE: local
      # HTTP 포트 변경
      KC_HTTP_PORT: 8079
    command: start-dev
    volumes:
      # 테마 및 설정 커스터마이징을 위한 볼륨 (선택사항)
      - ./keycloak/themes:/opt/keycloak/themes:z
      - ./keycloak/conf:/opt/keycloak/conf:z
      - ./keycloak/data:/opt/keycloak/data:z
    expose:
      - "8079"
    restart: unless-stopped
    # Health check 비활성화
    healthcheck:
      disable: true
    # traefik 라벨 추가
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-net"
      - "traefik.http.routers.keycloak.rule=Host(`auth.lyckabc.xyz`)"
      - "traefik.http.routers.keycloak.entrypoints=websecure"
      - "traefik.http.routers.keycloak.tls.certresolver=letsencrypt"
      - "traefik.http.services.keycloak.loadbalancer.server.port=8079"
      # 추가: X-Forwarded 헤더 설정
      - "traefik.http.middlewares.keycloak-headers.headers.customrequestheaders.X-Forwarded-Proto=https"
      - "traefik.http.middlewares.keycloak-headers.headers.customrequestheaders.X-Forwarded-Port=443"
      - "traefik.http.routers.keycloak.middlewares=keycloak-headers"
    networks:
      - traefik-net
      - neunexus_network
networks:
  traefik-net:
    external: true
  neunexus_network:
    external: true
