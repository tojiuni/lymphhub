version: '3.8'

services:
  # --- LymphHub Service ---
  lymphhub-backend:
    build:
      context: ../backend
    environment:
      - KEYCLOAK_SERVER_URL=${KEYCLOAK_URL}
      - KEYCLOAK_REALM=${KEYCLOAK_REALM}
      - KEYCLOAK_CLIENT_ID=${KEYCLOAK_CLIENT_ID}
      - KEYCLOAK_CLIENT_SECRET=${KEYCLOAK_CLIENT_SECRET}
      - LYMPHHUB_PUBLIC_URL=${LYMPHHUB_PUBLIC_URL}
      - COOKIE_DOMAIN=${COOKIE_DOMAIN}
    networks:
      - traefik-net
      - neunexus_network
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-net"
      # Router Config
      - "traefik.http.routers.lymphhub-api.rule=Host(`${LYMPHHUB_PUBLIC_URL}`)"
      - "traefik.http.routers.lymphhub-api.entrypoints=websecure"
      - "traefik.http.routers.lymphhub-api.tls.certresolver=letsencrypt"
      - "traefik.http.services.lymphhub-api.loadbalancer.server.port=8000"

      # --- DEFINE THE AUTH MIDDLEWARE HERE ---
      - "traefik.http.middlewares.lymphhub-auth.forwardauth.address=http://lymphhub-backend:8000/api/auth"
      - "traefik.http.middlewares.lymphhub-auth.forwardauth.trustForwardHeader=true"
      - "traefik.http.middlewares.lymphhub-auth.forwardauth.authResponseHeaders=X-Auth-User,X-Auth-Email,X-Auth-Name"

  lymphhub-frontend:
    build:
      context: ../frontend
      dockerfile: Dockerfile
    environment:
      - NEXT_PUBLIC_API_URL=https://${LYMPHHUB_PUBLIC_URL}
    networks:
      - traefik-net
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-net"
      - "traefik.http.routers.lymphhub-web.rule=Host(`${LYMPHHUB_FRONTEND_URL}`)"
      - "traefik.http.routers.lymphhub-web.entrypoints=websecure"
      - "traefik.http.routers.lymphhub-web.tls.certresolver=letsencrypt"
      - "traefik.http.services.lymphhub-web.loadbalancer.server.port=3000"

networks:
  traefik-net:
    external: true
  neunexus_network:
    external: true
