{
    email {$EMAIL}
    # Authelia Caddy 연동: trusted proxies (문서 권장 범위)
    # https://www.authelia.com/integration/proxies/caddy/#trusted-proxies
    # trusted_proxies 10.0.0.0/8 172.16.0.0/12 192.168.0.0/16 fc00::/7
    servers {
        trusted_proxies static private_ranges
    }
}
# --- 인증 로직 재사용을 위한 Snippet ---
(auth_check) {
    forward_auth authelia:9091 {
        uri /api/authz/forward-auth?authelia_url=https://auth.{$DOMAIN}/
        copy_headers Remote-User Remote-Groups Remote-Email Remote-Name
    }
}
# --- TLS 설정 재사용을 위한 Snippet ---
(zerossl_tls) {
    tls {
        issuer acme https://acme.zerossl.com/v2/DV90 {
            eab {$ZEROSSL_EAB_KEY_ID} {$ZEROSSL_EAB_HMAC_KEY}
            dns cloudflare {$CF_API_TOKEN}
        }
    }
}
# 1. Authelia 포털 (인증 제외)
auth.{$DOMAIN} {
    import zerossl_tls
    
    @auth_root method GET path / not query rd
    handle @auth_root {
        # 로그인 성공 후 돌아갈 기본 페이지 설정 (예: public.도메인)
        redir /?rd=https://{$DOMAIN}/ 302
    }
    
    handle {
        reverse_proxy authelia:9091
    }
}
# 2. DB 관리 서비스 (예: pgAdmin - 인증 예외 또는 별도 처리)
# 만약 DB 툴은 인증 없이 내부망에서만 쓰고 싶다면 (auth_check)를 생략합니다.
rdb.{$DOMAIN} {
    import zerossl_tls
    # import auth_check  <-- 인증을 걸고 싶다면 주석 해제
    
    reverse_proxy pgadmin:80
}

# 3. 그 외 모든 서브도메인 (기본적으로 인증 적용)
*.{$DOMAIN} {
    import zerossl_tls
    import auth_check

    # 인증 통과 후 실제 서비스로 연결하는 로직 필요
    # 여기서는 예시로 각 서브도메인 이름과 같은 컨테이너로 보냅니다.
    reverse_proxy {labels.0}:80
}

*.lyckabc.xyz {
    import zerossl_tls
    import auth_check

    # 인증 통과 후 실제 서비스로 연결하는 로직 필요
    # 여기서는 예시로 각 서브도메인 이름과 같은 컨테이너로 보냅니다.
    # 1. 특정 하위 경로에서 발생하는 문제 방지 및 헤더 최적화
    reverse_proxy {labels.0}:80 {
        # 백엔드에 원래 요청된 Host(예: app.lyckabc.xyz)를 그대로 전달
        header_up Host {host}
        
        # 실제 클라이언트 IP 전달 (인증 및 로그 분석용)
        header_up X-Real-IP {remote_host}
        
        # 일부 앱에서 리다이렉트 시 HTTP/HTTPS 혼동 방지
        header_up X-Forwarded-Proto {scheme}
    }
}